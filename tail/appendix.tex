\appendix
\chapter{Analytical solution to force balance equations}

\section{Ideal MHD}
\label{appendix jxb=grad p solution}
We solve here the ideal MHD equilibrium equations (\ref{equation perp force balance})-(\ref{equation div B ideal mhd}) in a cylinder or length $L$ and radius $a$. We work with cylindrical coordinate $(r,\theta,z)$. We assume that the cylinder boundary is a perfectly conducting wall, \textit{i.e.} $\mathbf{B}\cdot\nabla r=0$ at $r=a$. Assuming symmetries along $\theta$ and $z$ (equivalent to axisymmetry in a toroidal geometry), we directly get that $p=p(r)$, \textit{i.e.} isopressure surfaces are cylinders with constant radii. Since the magnetic field lies on constant pressure surfaces, axisymmetry implies the existence of magnetic surfaces everywhere.

We now search for a solution to the equilibrium equation. One gets from equation (\ref{equation div B ideal mhd})
\begin{align}
\frac{1}{r}\frac{\partial}{\partial r}(r B_r) &= 0, 
\end{align}
which, once the boundary condition is applied, leads to $B_r=0$. In addition, exploiting Ampere's law, we write the current densities as
\begin{align}
	\mu_0J_r &= 0\\
	\mu_0J_\theta &= -\frac{\partial B_z}{\partial r}\\
	\mu_0J_z &= \frac{1}{r}\frac{\partial}{\partial r}(rB_\theta).
\end{align} 
Finally, taking the cross product of the current density with the magnetic field and rearranging the terms, one gets
\begin{equation}
	\frac{d}{dr}\left(\mu_0p + \frac{B_\theta^2 + B_z^2}{2}\right) + \frac{B_\theta^2}{r} = 0.
\end{equation}

The equilibrium is thus completely determined if one provides (i) a pressure profile $p(r)$ and (ii) a constraint on either the poloidal or toroidal magnetic field --- for example by providing the poloidal flux profile $\psi_p(r)$ or the rotational transform profile $\iotabar(r)$.


\chapter{Linear relation between surface currents and poloidal fluxes}\label{appA1}

In this appendix we show the linear relation between the surface currents (\ref{eq.surf_current}) and the poloidal fluxes in an \ac{MRxMHD} equilibrium. We rewrite here Eq.(\ref{eq.surf_current}) for convenience,

\begin{equation}
	\mu_0I^s_{l,\phi} = 2\pi\left[\left[\tilde{B}_\theta\right]\right]_l.
\end{equation}

We use general coordinates notation, with $u^i\equiv\{s,\theta,\phi\}$, $\{\nabla s,\nabla\theta,\nabla\phi\}$ the contravariant basis, and $\mathbf{e_i}\equiv\{\mathbf{e_s},\mathbf{e_\theta},\mathbf{e_\phi}\}$ the covariant basis. This derivation is local to a volume and we drop the subscript $l$ everywhere for simplicity.

We first show that the surface currents depend linearly on the vector potential degrees of freedom $\mathbf{a}$. The contravariant components of the magnetic field are obtained from $\nabla\times\mathbf{A}=\mathbf{B}$,
\begin{equation}
	B^k = \frac{\epsilon^{ijk}}{\sqrt{g}}\frac{\partial A_j}{\partial u^i},
\end{equation}
where  $\epsilon^{ijk}$ is the Levi-Civita tensor, $\sqrt{g}$ is the jacobian, and the Einstein summation convention has been used. The covariant component of the magnetic field can then easily be expressed by $B_\theta = g_{k\theta}B^k$. The $m=n=0$ Fourier mode of $B_\theta$ is then

\begin{equation}
	\tilde{B}_\theta = \frac{1}{S}\int_0^{2\pi}\int_0^{2\pi} g_{k\theta}\epsilon^{ijk}\frac{\partial A_j}{\partial u^i}|\nabla\psi_t| d\theta d\phi, \label{eq.AppA1.1}
\end{equation}
with $S$ the total area of the flux surface, which depends only on geometrical quantities. Derivatives of $A_j$ are

\begin{align}
	\frac{\partial A_j}{\partial s} &= \sum_{m,n}\sum_{k=0}^{L_{rad}} A_{i,k,m,n}T'_k(s)\cos(m\theta-nN_p\phi) \label{eq.AppA1.2} \\
	\frac{\partial A_j}{\partial \theta} &= \sum_{m,n}\sum_{k=0}^{L_{rad}} -mA_{i,k,m,n}T_k(s)\sin(m\theta-nN_p\phi) \\
	\frac{\partial A_j}{\partial \phi} &= \sum_{m,n}\sum_{k=0}^{L_{rad}} nN_pA_{i,k,m,n}T_k(s)\sin(m\theta-nN_p\phi) , \label{eq.AppA1.3}
\end{align}
where the prime denotes the derivative with respect to the main argument. Equations (\ref{eq.AppA1.1}) and (\ref{eq.AppA1.2})-(\ref{eq.AppA1.3}) combined show the linear dependence of $\tilde{B}_\theta$ on $\mathbf{a}$. Finally, the Beltrami equation (\ref{eq.linearized_beltrami_system}) provides a linear relation between $\mathbf{a}$ and $\{\psi_p,\psi_t,\mu\}$. All relations being linear, this shows that the surface currents depend linearly on the poloidal and toroidal magnetic fluxes.

\chapter{Fixed toroidal current profiles in a free-boundary equilibrium}\label{appA}

In this appendix, the main differences between a fixed- and free-boundary calculation with the new developed current constraint are outlined. The linear system (\ref{eq.psip_diff}) has to be rewritten by extending the arrays $\bm{\psi}$ and $\mathbf{I}$ with two new pairs of scalars $(\psi_{p,V}, \psi_{t,V})$ and ($I^s_{N_{vol}}, I_{coil}$), namely $\bm{\psi}\equiv(\psi_{p,2},\ldots,\psi_{N_{vol}}, \psi_{p,V}, \psi_{t,V})^t$ and $\bm{I}\equiv(I^s_1,\ldots,I^s_{N_{vol}},I_{coil})^t$. Then,

\begin{equation}
	\mathbf{M}_{Fr} (\overbar{\bm{\psi}} - \bm{\psi}) = \overbar{\bm{I}} - \bm{I},
\end{equation}
with the matrix $\mathbf{M}_{Fr}$,

\begin{equation}
	\mathbf{M}_{Fr} = \frac{2\pi}{\mu_0} \begin{bmatrix}
		\dfrac{\partial \tilde{B}^-_{\theta,2}}{\partial{\psi_{p,2}}} & 0 & \cdots  & \cdots & \cdots & 0\\
		-\dfrac{\partial \tilde{B}^+_{\theta,2}}{\partial{\psi_{p,2}}} & \dfrac{\partial \tilde{B}^-_{\theta,3}}{\partial{\psi_{p,3}}} & 0  & \cdots & \cdots & 0\\
		\vdots  & \ddots  & \ddots & \ddots & \ddots & 0\\
		0 & 0 & -\dfrac{\partial \tilde{B}^+_{\theta,N_{vol}-1}}{\partial{\psi_{p,N_{vol}-1}}} & \dfrac{\partial \tilde{B}^-_{\theta,N_{vol}}}{\partial{\psi_{p,N_{vol}}}} & 0 & 0 \\
		\vdots & \cdots & 0 & -\dfrac{\partial \tilde{B}^+_{\theta,N_{vol}}}{\partial{\psi_{p,N_{vol}}}} & \dfrac{\partial \tilde{B}^-_{\theta,V}}{\partial{\psi_{p,V}}} & \dfrac{\partial \tilde{B}^-_{\theta,V}}{\partial{\psi_{t,V}}} \\
		0 & \cdots & \cdots & 0 & \dfrac{\partial \tilde{B}_{\phi,V}^-}{\partial \psi_{p,V}} & \dfrac{\partial \tilde{B}_{\phi,V}^-}{\partial \psi_{t,V}}
	\end{bmatrix},
\end{equation}
with $\tilde{B}^-_{\phi,V}$ the $m=n=0$ Fourier mode of the covariant toroidal magnetic field on the plasma boundary outer side. Regarding Eq.(\ref{eq.NewtonStep_Solution}), no changes are needed in the plasma volumes. In the vacuum region, however, the toroidal flux is not an input and an additional term is needed,

\begin{equation}
	A_{V,i} = \overbar{A_{V,i}} - \frac{\partial {A_{V,i}}}{\partial {\psi_{p,V}}} (\overbar{\psi_{p,V}} - \psi_{p,V}) - \frac{\partial {A_{V,i}}}{\partial {\psi_{t,V}}} (\overbar{\psi_{t,V}} - \psi_{t,V}),
\end{equation}
where the subscript $V$ denotes the vacuum region.

Regarding the force gradient, the derivative of the toroidal flux with respect to the geometry is non-zero in the vacuum region. This means that
\begin{equation}
	\frac{d\tilde{B}_{\theta,V}}{dx_i} = \frac{\partial \tilde{B}^-_{\theta,V}}{\partial x_i} + \frac{\partial \tilde{B}^-_{\theta,V}}{\partial \psi_{t,V}}\frac{d \psi_{t,V}}{d x_i} + \frac{\partial \tilde{B}^-_{\theta,V}}{\partial \psi_{p,V}}\frac{d \psi_{p,V}}{d x_i},
\end{equation}
An additional equation is required for $\dfrac{d\psi_{t,V}}{dx_i}$, and is provided by

\begin{equation}
	\frac{dI_{coil}}{dx_i} = \frac{2\pi}{\mu_0}\left( \frac{\partial  \tilde{B}^+_{V,\phi}}{\partial x_i} + \frac{\partial  \tilde{B}^+_{V,\phi}}{\partial \psi_{p,V}}\frac{\partial\psi_{p,V}}{\partial x_i} +  \frac{\partial  \tilde{B}^+_{V,\phi}}{\partial \psi_{t,V}}\frac{\partial \psi_{t,V}}{\partial x_i} \right)   =0,
\end{equation}
leading to

\begin{equation}
	\mathbf{M}_{Fr} \cdot 
	\dfrac{d}{dx_i}\bm{\psi} = \frac{2\pi}{\mu_0} \begin{bmatrix}
		\dfrac{\partial \tilde{B}^+_{\theta,1}}{\partial x_i} - \dfrac{\partial \tilde{B}^-_{\theta,2}}{\partial x_i} \\
		\vdots \\
		\dfrac{\partial \tilde{B}^+_{\theta,N_{vol}} } {\partial x_i} - \dfrac{\partial \tilde{B}^-_{\theta,V}}{\partial x_i} \\
		-\dfrac{\partial\tilde{B}^-_{\phi,V}}{\partial x_i}
	\end{bmatrix}
\end{equation}



\chapter{Beltrami equation solution in an axisymmetric cylinder}\label{appB}

The solution to the Beltrami equation (\ref{eq.BeltramiEquation}) in the $l^{\text{th}}$ volume of an axisymmetric cylinder is
	\begin{equation}
		\mathbf{B}_l = \left[c_{l,1}rJ_1(\mu_l r) + c_{l,2}rY_1(\mu_lr)\right] \nabla\theta + \left[c_{l,1}J_0(\mu_l r) + c_{l,2}Y_0(\mu_lr)\right] \nabla\phi,
\end{equation}
where the usual $(r,\theta,\phi)$ cylindrical coordinate system has been used, $J_i$ and $Y_i$ are the Bessel functions of the $i^\text{th}$ order of the first and second kind, respectively, and $c_{l,1}$, $c_{l,2}$ are integration constants. Here $\nabla\theta$ and $\nabla\phi$ are the contravariant basis vectors.

In addition, since $B_\theta$ must vanish at the origin, we have that $c_{1,2}=0$. Indeed, the asymptotic expansion of $Y_1(x)$ close to $x=0$ gives \citep{abramowitz_handbook_1964}

\begin{equation}
	\lim_{r\rightarrow 0} c_{1,2}rY_1(\mu_1 r) \sim \lim_{r\rightarrow 0} -c_{1,2}r\frac{2}{\pi r} = -\frac{2c_{1,2}}{\pi},
\end{equation}
which is only zero if $c_{1,2}=0$. 

We consider now the case of a screw pinch with three inner volumes, $N_{vol}=3$. The assumed constrained profiles are the toroidal flux $\{\psi_{t,l}\}_{l=1,2,3}$, the volume current $\{I^{v}_{l,\phi}\}_{l=1,2,3}$ and the surface current $\{I^{s}_{l,\phi}\}_{l=1,2}$. The constraint on the toroidal flux is

\begin{align}
	\psi_{t,l} &= \iint_{S_{l,\phi}} \mathbf{B}\cdot\nabla\phi \sqrt{g} dr d\theta\\
	&= \int_{R_{l-1}}^{R_l} dr \int_0^{2\pi} d\theta \left[ c_{l,1} J_0(\mu_l r) r + c_{l,2} Y_0(\mu_l r)r \right]\\
	&\equiv 2\pi c_{l,1} \bar{J}_l + 2\pi c_{l,2} \bar{Y}_l,
\end{align}
where $\sqrt{g}=r$ is the jacobian and $S_{l,\phi}$ is a constant-$\phi$ surface in volume $l$. The Bessel function integrals have been renamed as $\bar{J}_l$ and $\bar{Y}_l$, and $R_l$ is the radius of the $l^{\text{th}}$ interface. The constraints on the currents lead to

\begin{align}
	\mu_0I^{v}_{l,\phi} &= \frac{\mu_l}{\mu_0} \psi_{t,l}\\
	\mu_0I^{s}_{l,\phi} &= 2\pi R_l \left[ c_{l+1,1}J_1(\mu_{l+1}R_l) - c_{l,1}J_1(\mu_{l}R_l) + c_{l+1,2}Y_1(\mu_{l+1}R_l) -
	c_{l,2}Y_1(\mu_{l}R_l)\right],
\end{align}
Solving for $\{c_{l,1},c_{l,2}\}$ is equivalent to solving the linear system

\begin{equation}
	\begin{bmatrix}
		\bar{J}_{1} & 0 & 0 & 0 & 0 \\
		0 & \bar{J}_{2} & \bar{Y}_{2} & 0 & 0 \\
		0 & 0 & 0 & \bar{J}_{3} & \bar{Y}_{3} \\
		-J_1(\mu_1 R_1) & J_1(\mu_2 R_1) & Y_1(\mu_2 R_1) & 0 & 0 \\
		0 & -J_1(\mu_2 R_2) & -Y_1(\mu_2 R_2) & J_1(\mu_3 R_2) & Y_1( \mu_3, R_2)
	\end{bmatrix}
	\begin{bmatrix}
		c_{1,1}\\
		c_{2,1}\\
		c_{2,2}\\
		c_{3,1}\\
		c_{3,2}
	\end{bmatrix}
	=
	\begin{bmatrix}
		\psi_{t,1} / 2\pi\\
		\psi_{t,2} / 2\pi\\
		\psi_{t,3} / 2\pi\\
		\mu_0I^{surf}_1 / 2\pi R_1\\
		\mu_0I^{surf}_2 / 2\pi R_2
	\end{bmatrix} \label{eq.linear_system_constraint_SP}
\end{equation}

Derivatives of the force $F_l= [(B_{l+1}(R_l))^2-(B_l(R_l))^2] / 2$ can also be expressed analytically, leading to

\begin{align}
	\frac{\partial F_l}{\partial R_j} = \frac{1}{2} \frac{\partial \left(B_{l+1}(R_l)\right)^2}{\partial R_j} - \frac{1}{2} \frac{\partial \left(B_{l}(R_l)\right)^2}{\partial R_j},
\end{align}
with $l,j\in\{1,2\}$. Consider, \textit{e.g.}, the derivative of $B_l(R_k),\ k=\{l-1,l\}$,

\begin{align}
	\left[B_l(R_k)\right]^2 &= \left[c_{l,1}J_1(\mu_lR_k)+c_{l,2}Y_1(\mu_lR_k)\right]^2 + \left[c_{l,1}J_0(\mu_lR_k)+c_{l,2}Y_0(\mu_lR_k)\right]^2  \\
	B_l\frac{\partial B_l}{\partial R_k} &= (c_{l,1}J_1 + c_{l,2}Y_1)(c'_{l,1}J_1 + c_{l,1}\mu_lJ_1' + c_{l,2}'Y_1 + c_{l,2}\mu_lY_1') \\
	&+ (c_{l,1}J_0 + c_{l,2}Y_0)(c'_{l,0}J_0 + c_{l,2}\mu_lJ_0' + c_{l,2}'Y_0 + c_{l,2}\mu_lY_0')
\end{align}
where the $'$ denotes a derivative with respect to the function argument, and all Bessel functions are evaluated at $\mu_lR_k$. Finally, all derivatives must be taken at constant $\psi_{t,l}$, $I^{vol}_l$ and $I^{surf}_l$. In particular, the coefficients $\dfrac{dc_{l,i}}{dR_k}$ are obtained from derivatives of Eq.(\ref{eq.linear_system_constraint_SP}) with respect to $R_k$.




\chapter{Boozer coordinates}
\label{appendix boozer coordinates}
In this appendix, we follow \citet{Helander2014} to derive a transformation from general toroidal coordinates $(p,\theta,\phi)$, where $p$ is the pressure, and $(\theta,\phi)$ are general poloidal and toroidal angles, to boozer coordinates $(\psi_t,\theta_b,\phi_b)$, where $\psi_t$ is the toroidal flux and $(\theta_b,\phi_b)$ are the poloidal and toroidal Boozer angles. We start by considering the force balance equation of ideal MHD, \textit{i.e.} equation (\ref{equation perp force balance}), which implies that $\mathbf{B}\cdot\nabla p =0$. The magnetic field can thus be written as
\begin{equation}
	\mathbf{B} = B_1(p,\theta,\phi)\nabla p\times\nabla\theta + B_2(p,\theta,\phi)\nabla\phi\times\nabla p.
\end{equation}
We derive 
\begin{align}
	\nabla\cdot[B_1\nabla p \times\nabla\theta] &= \frac{\partial B_1}{\partial \phi}\nabla\phi\cdot(\nabla p \times\nabla\theta)\\
	\nabla\cdot[B_2\nabla\phi\times\nabla p] &= \frac{\partial B_2}{\partial \phi}\nabla\phi\cdot(\nabla p \times\nabla\theta),
\end{align}
which, according to the equation $\nabla\times\mathbf{B}=0$, imply
\begin{equation}
	\left(\frac{\partial B_1}{\partial\phi}+\frac{\partial B_2}{\partial \theta}\right) \nabla p \cdot(\nabla\theta\times\nabla\phi)=0.
\end{equation}
As we assume our coordinates not to be degenerate, \textit{i.e.} the inverse jacobian never cancels, $\nabla p \cdot(\nabla\theta\times\nabla\phi) = 1/\sqrt{g} \neq 0$, we deduce $\partial B_1/\partial\phi + \partial B_2/\partial\theta =0$. Integrating over a poloidal loop, and leveraging the $2\pi$ periodicity of $\mathbf{B}$ on $\theta$, we get that
\begin{align}
	{}&\frac{\partial}{\partial\phi} \int_0^{2\pi} B_1d\theta =0\qquad\forall\{p,\phi\}\\
	\text{Thus}\qquad &\int_0^{2\pi}B_1 d\theta = g(p)\\
	\text{and}\qquad&B_1=\frac{\partial f}{\partial\theta} + \frac{g(p)}{2\pi}.
\end{align}
with $f=f(p,\theta,\phi)$ and $g=g(p)$ two functions. Similarly, we get for $B_2$,
\begin{equation}
	B_2 = -\frac{\partial f}{\partial \phi} + \frac{h(p)}{2\pi},
\end{equation}
with $h=h(p)$ another function. Defining $\psi_t'(p)=g(p)/2\pi$, $\psi_p'(p)=h(p)/2\pi$ and $\lambda=f(p,\theta,\phi)/\psi_t'(p)$, we get
\begin{equation}
	\mathbf{B} = \left(1=\frac{\partial\lambda}{\partial\theta}\right)\psi_t'(p)\nabla p\times\nabla\theta + \left(\psi_p'(p)-\psi_t'(p)\frac{\partial\lambda}{\partial\phi}\right)\nabla\phi\times\nabla p.
\end{equation}
We define now the \emph{straight field line angle} $\theta_s$ as 
\begin{equation}
	\theta_s = \theta + \lambda.
\end{equation}
Using the \emph{straight field line coordinates} $(\psi_t,\theta_s,\phi)$, the magnetic field can be written as
\begin{equation}
	\mathbf{B}=\nabla\psi_t\times\nabla\theta_s + \nabla\phi\times\nabla\psi_t. \label{eq.magnetic field covariant}
\end{equation}
It can be easily verified that the functions $\psi_t(p)$ and $\psi_p(p)$ are the toroidal and poloidal fluxes respectively. The straight field line coordinates have the property that magnetic field lines are straight when plotted in the $(\theta_s,\phi)$ plane --- indeed, the rotational transform is defined as $\iotabar=d\psi_p/d\psi_t$, and since the poloidal flux depends on the toroidal flux only, $\iotabar=\iotabar(\psi_t)$. We thus have
\begin{equation}
	\iotabar(\psi_t) = \frac{\nabla\psi_p}{\nabla\psi_t} = \frac{(\nabla\theta_s\times\nabla\phi)\cdot\nabla\psi_p}{(\nabla\theta_s\times\nabla\phi)\cdot\nabla\psi_t} = \frac{(\nabla\phi\times\nabla\psi_p)\cdot\nabla\theta_s}{(\nabla\psi_t\times\nabla\theta_s)\cdot\nabla\phi} = \frac{\mathbf{B}\cdot\nabla\theta_s}{\mathbf{B}\cdot\nabla\phi} = \left.\frac{d\theta_s}{d\phi}\right|_{\text{along }\mathbf{B}}
\end{equation}
\textit{i.e.} field lines are straight in the $(\theta_s,\phi)$ plane. Here, $B^i$ is the contravariant componant of the magnetic field.

Equation (\ref{eq.magnetic field covariant}) is the covariant representation of the magnetic field in straight field line coordinates. Leveraging the charge conservation equation $\nabla\cdot\mathbf{J}=0$ and $\nabla\times\mathbf{B}=\mathbf{J}$, one can derive a contravariant representation. We start by noticing that the force balance equation (\ref{equation perp force balance}) implies that $\mathbf{J}\cdot\nabla p =0$. Using the same reasoning as for the magnetic field, we can write
\begin{equation}
	\mathbf{J}=J_1\nabla\psi_t\times\nabla\theta_s + J_2\nabla\phi\times\nabla\psi_t.
\end{equation}
Charge conservation implies
\begin{align}
	J_1(\psi_t,\theta_s,\phi) &= I'(\psi_t) - \frac{\partial K}{\partial \theta_s}\\
	J_2(\psi_t,\theta_s,\phi) &= -G'(\psi_t) + \frac{\partial K}{\partial \phi},
\end{align}
with $I=I(\psi_t)$ and $G=G(\psi_t)$ two functions that depend only on the toroidal flux and $K=K(\psi_t,\theta_s,\phi)$ another function that depends on the position. Now, we notice that the curl of $I\nabla\theta_s + G\nabla\phi + K\nabla\psi_t$ gives
\begin{equation}
	\nabla\times(I\nabla\theta_s + G\nabla\phi + K\nabla\psi_t) = \left(I'-\frac{\partial K}{\partial \theta_s}\right) \nabla\psi_t\times\nabla\theta_s + \left(-G'+\frac{\partial K}{\partial \phi}\right) \nabla\psi_t\times\nabla\phi.
\end{equation}
We can thus identify
\begin{align}
	J_1 &= I'-\frac{\partial K}{\partial \theta_s}\\
	J_2 &= -G'+\frac{\partial K}{\partial \phi}\\
	\mathbf{B} &= I\nabla\theta_s + G\nabla\phi + K\nabla\psi_t + \nabla H, \label{eq. contravariant magnetic field}
\end{align}
where $H=H(\psi_t,\theta_s,\phi)$ is an integration constant. Equation (\ref{eq. contravariant magnetic field}) is the contravariant representation of the magnetic field in straight field line coordinates. Note that $I$ can easily be identified as the total toroidal current enclosed by the magnetic surface labelled by $\psi_t$ and $G$ as the total poloidal current outside the magnetic surface labelled by $\psi_t$.

In the straight field line coordinates derived above, the toroidal angle $\phi$ is still completely general --- a straight field line poloidal angle $\theta_s$ exist for any choice of toroidal angle $\phi$. There is however a specific choice of toroidal angle $\phi_b$, called the Boozer angle, for which $H=0$. To derive it, we define a function $\omega=\omega(\psi_t,\theta_s,\phi)$ and the transformation
\begin{align}
	\theta_b &= \theta_s -\iotabar\omega\\
	\phi_b &= \phi - \omega.
\end{align}
Note that
\begin{align}
	\mathbf{B} &= \nabla\psi_t\times\nabla\theta_s + \nabla\phi\times\nabla\psi_p\\
	&= \nabla\psi_t\times\nabla(\theta_b+\iotabar\omega) + \nabla(\phi_b+\omega)\times\nabla\psi_p\\
	&= \nabla\psi_t\times\nabla\theta_b + \nabla\phi_b\times\nabla\psi_p + \underbrace{\frac{d\psi_p}{d\psi_t}\nabla\psi_t\times\nabla\omega - \nabla\psi_p\times\nabla\omega}_{=0}\\
	&= \nabla\psi_t\times\nabla\theta_b + \nabla\phi_b\times\nabla\psi_p,
\end{align}
\textit{i.e.} the angles $(\theta_b,\phi_b)$ are also straight field line angles. Similarly, 
\begin{align}
	\mathbf{B} &= I\nabla(\theta_b+\iotabar\omega) + G\nabla(\phi_b+\omega) + K \nabla\psi_t + \nabla H\\
	&= I\nabla\theta_b + G\nabla\phi_b + \left[K-\omega\left(\iotabar\frac{dI}{d\psi_t}+\frac{dG}{d\psi_t}\right)\right]\nabla\psi_t + \nabla\left[H+(I\iotabar+G)\omega\right]\\
	&= I\nabla\theta_b + G\nabla\phi_b + K_b\nabla\psi_t + \nabla H_b,
\end{align}
where 
\begin{align}
	K_b &= K-\omega\left(\iotabar\frac{dI}{d\psi_t}+\frac{dG}{d\psi_t}\right)\\
	H_b &= H + \left(\iotabar I + G\right) \omega.
\end{align}
Thus, choosing the function $\omega$ to be 
\begin{equation}
	\omega = -\frac{H}{\iotabar I + G},
\end{equation}
we get the Boozer coordinates, where $H_b = 0$.






\chapter{SPEC spectral condensation} \label{spec coord and spectral constraints}
%SPEC can run in three different geometries, namely in slab \citep{Loizu2019},  cylindrical \citep{Loizu2016a} and toroidal geometry \citep{Loizu2016}. The coordinates used to describe position are
%
%\begin{equation}
%	\mathbf{x} = \begin{cases}
%		\theta\hat{\mathbf{i}} + \phi\hat{\mathbf{j}} + R\hat{\mathbf{k}} \qquad &\text{in slab geometry},\\
%		R\cos\theta\hat{\mathbf{i}} + R\sin\theta\hat{\mathbf{j}} + \phi\hat{\mathbf{k}} \qquad &\text{in cylindrical geometry},\\
%		R\cos\phi\hat{\mathbf{i}} + R\sin\phi\hat{\mathbf{j}} + Z\hat{\mathbf{k}} \qquad &\text{in toroidal geometry},
%	\end{cases}
%\end{equation}
%where $\{\hat{\mathbf{i}},\hat{\mathbf{j}},\hat{\mathbf{k}}\}$ is the unitary Cartesian basis, $\theta$ is a poloidal angle and $\phi$ is the usual toroidal angle. The geometry of interface $\mathcal{I}_l$, are described by decomposing the coordinates $R$ and $Z$ on a Fourier basis,
%
%\begin{align}
%	R_l(\theta,\phi) &= \sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}}R_{l,m,n} \cos(m\theta-nN_p\phi)\\
%	Z_l(\theta,\phi) &= \sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}}Z_{l,m,n} \sin(m\theta-nN_p\phi),
%\end{align}
%where $N_p$ is the number of field periods, $M_{pol}$ and $N_{tor}$ are the poloidal and toroidal mode numbers above which Fourier series are truncated, \textit{i.e.} $m=\{0,\ldots,M_{pol}\}$, $n=\{-N_{tor},\ldots,N_{tor}\}$, and stellarator symmetry has been assumed for simplicity. Between interfaces $l$ and $l+1$, coordinates are constructed by linear interpolation of $(R,Z)_l$ and $(R,Z)_{l+1}$ using a radial-like coordinate $s$. 
The standard representation given in Eqs.(\ref{eq.Rmns})-(\ref{eq.Zmns})) depends on the choice of poloidal angle $\theta$. In SPEC, a so-called \emph{spectral condensation} \citep{Hirshman1986} is implemented to select the poloidal angle. The idea is to minimize the number of Fourier harmonics required to represent a surface, \textit{i.e.} minimize
\begin{equation}
	M_l = \frac{1}{2}\sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}} m^\lambda (R_{mn}^2 + Z_{mn}^2), \label{eq.spectral width}
\end{equation}
where only variations tangential to the surface are allowed, $\delta R = R_\theta\delta u$ and $\delta Z = Z_\theta\delta u$, where the $X_i$ designates a derivative of $X$ with respect to $i$ and $\delta u$ is arbitrary, and $\lambda$ is a user input. In SPEC, an additional target is included in the minimization, called the \emph{spectral length} --- its role is to ensure smooth transition between the angles used to represent inner plasma interfaces and the plasma boundary. It is expressed for volume $\mathcal{V}_l$ as 
\begin{equation}
	L_l = \oint\oint\sum_{i=1}^{N_s}\sqrt{[R_l(\theta,\phi)-R_{l-1}(\theta,\phi)]^2 +  [Z_l(\theta,\phi)-Z_{l-1}(\theta,\phi)]^2}d\theta d\phi, \label{eq.spectral length}
\end{equation}
where $N_s$ is the number of radial grid points $s_i$. Finally, the zero of the poloidal angle is constrained to be such that ${Z}_l(\theta=0,\phi)$ is equal to the geometrical center of the interface $Z_{l,0}$, which can be enforced by minimizing
\begin{equation}
	S_l = \frac{1}{2}\oint ({Z}_l(0,\phi) - Z_{l,0})^2 d\phi, \label{eq.spectral zero}
\end{equation}
with
\begin{equation}
	Z_{l,0} = \oint d\theta Z_l(\theta,\phi)\sqrt{R_{l,\theta}(\theta,\phi)^2 + Z_{l,\theta}(\theta,\phi)^2}.
\end{equation}

The target ot minimize is then a linear combination of all angular targets, Eqs.(\ref{eq.spectral width})-(\ref{eq.spectral zero}),
\begin{equation}
	W_{sc} = \sum_{l=1}^{N_{vol}-1} \alpha_lM_l + \beta_lL_l + \gamma_l S_l,
\end{equation}
where $(\alpha_l,\beta_l,\gamma_l)$ are user supplied weights, and $\psi_a$ is the total toroidal flux enclosed by the plasma. One can show that this can be written under the form

\begin{equation}
	\delta W_{sc} = \oint\oint F^{sc}(\theta,\phi) \delta u d\theta d\phi,
\end{equation}
meaning that the minimum of $W_{sc}$ is found for 

\begin{equation}
	F^{sc} = \sum_{m=0}^{M_{pol}} \sum_{n=-N_{tor}}^{N_{tor}} F^{sc}_{mn} \sin(m\theta-nN_{fp}\phi) = 0. \label{eq. spectral constraint}
\end{equation}


\chapter{Toroidal coordinates} \label{app. toroidal coordinates}
We derive in this appendix the metric and jacobian analytical relations in toroidal coordinates $(s,\theta,\zeta)$. The position vector is given by
\begin{equation}
	\mathbf{x}=R(s,\theta,\zeta)\mathbf{e}_R+Z(s,\theta,\zeta)\mathbf{e}_Z,
\end{equation}
with $\mathbf{e}_R$, $\mathbf{e}_\phi$, and $\mathbf{e}_Z$ the usual unitary basis vector in cylindrical geometry (see Figure \ref{fig.spec coordinates}). The covariant basis vector are given by $\mathbf{e}_i=\partial\mathbf{x}/\partial u^i$, 
\begin{align}
	\mathbf{e}_s &= R_s\mathbf{e}_R+Z_s\mathbf{e}_Z\\
	\mathbf{e}_\theta &= R_\theta\mathbf{e}_R+Z_\theta\mathbf{e}_Z\\
	\mathbf{e}_\zeta &= R_\zeta\mathbf{e}_R+R\mathbf{e}_\phi +Z_\zeta\mathbf{e}_Z,
\end{align}
where the subscripts denote partial derivatives. The jacobian is then obtained by taking the triple product between the covariant basis vector, 
\begin{align}
	\sqrt{g}&=\mathbf{e}_s\cdot (-RR_\theta\mathbf{e}_R + (R_\theta Z_\zeta-R_\zeta Z_\theta)\mathbf{e}_\zeta + RR_\theta\mathbf{e}_Z)\\
	&= R(R_\theta Z_s - R_s Z_\theta).
\end{align}
The contravariant basis is obtained by taking the cross-product of the covariant basis and normalizing by the jacobian,
\begin{align}
	\nabla s &= \frac{1}{\sqrt{g}} \mathbf{e}_\theta\times\mathbf{e}_\zeta \\
	&= \frac{-RR_\theta\mathbf{e}_R + (R_\theta Z_\zeta-R_\zeta Z_\theta)\mathbf{e}_\zeta + RR_\theta\mathbf{e}_Z}{\sqrt{g}},
\end{align}
and similarly
\begin{align}
	\nabla\theta &= \frac{RR_s\mathbf{e}_R - (R_s Z_\zeta-R_\zeta Z_s)\mathbf{e}_\zeta - RR_s\mathbf{e}_Z}{\sqrt{g}}\\
	\nabla\zeta &= \frac{1}{\sqrt{g}}(R_\theta Z_s-R_s Z_\theta)\mathbf{e}_\phi.
\end{align}
Finally, the metric elements $g_{ij}$ are
\begin{equation}
	\mathbf{g}=\begin{pmatrix}
		R_s^2 + Z_s^2 & R_s R_\theta + Z_s Z_\theta &  R_s R_\phi + Z_s Z_\phi\\
		R_s R_\theta + Z_s Z_\theta & R_\theta^2 + Z_\theta^2 &  R_\theta R_\phi + Z_\theta Z_\phi\\
		R_s R_\phi + Z_s Z_\phi & R_\theta R_\phi + Z_\theta Z_\phi & R_\phi^2 + R^2 + Z_\phi^2
	\end{pmatrix}.
\end{equation}

% \chapter{Derivation of the Beltrami linear system} \label{app. beltrami eq coef derivation}

% Consider the Beltrami equation (\ref{eq.BeltramiEquation}). It is a linear relation between the vector potential Fourier-Chebyshev harmonics $A_{likmn}$ (see section \ref{sec. spec_algorithm}). We derive in this appendix how the Beltrami equation can be cast into a linear system
% \begin{equation}
% 	\left(\mathbf{A}_l-\mu_l\mathbf{D}_l\right)\mathbf{a_l} = \mathbf{C}_l.
% \end{equation}

% We rewrite for convenience the magnetic field contravariant components expressed with the vector potential harmonics (Eqs.(\ref{eq.bs contravariant})-(\ref{eq.bz contravariant})),
% \begin{align}
% 	B^s &= \frac{1}{\sqrt{g}}\sum_{k=0}^{L_{rad}}\sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}} -(mA_{l\phi kmn}+nA_{l\theta kmn})T_{km}(s)\sin(m\theta-nN_{fp}\phi) \label{eq. bs app}\\
% 	B^\theta &= \frac{1}{\sqrt{g}}\sum_{k=0}^{L_{rad}}\sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}} -A_{l\phi kmn}T_{km}'(s)\cos(m\theta-nN_{fp}\phi)\label{eq. bt app}\\
% 	B^\phi &= \frac{1}{\sqrt{g}}\sum_{k=0}^{L_{rad}}\sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}} A_{l\phi kmn}T_{km}'(s)\cos(m\theta-nN_{fp}\phi).\label{eq. bz app}
% \end{align}



% Derivatives of Eqs.(\ref{eq. bs app})-(\ref{eq. bz app}) with respect to $(s,\theta,\phi)$ are trivial. We have,
% \begin{align}
% 	\frac{\partial B^s}{\partial s} &= \frac{\partial}{\partial s}\left(\frac{1}{\sqrt{g}}\right)\sqrt{g}B^s \\
% 	&+ \frac{1}{\sqrt{g}}\sum_{k=0}^{L_{rad}}\sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}} -(mA_{l\phi kmn}+nA_{l\theta kmn})T_{km}'(s)\sin(m\theta-nN_{fp}\phi) \label{eq. dbsds app}\\
% 	\frac{\partial B^\theta}{\partial s} &= \frac{\partial}{\partial s}\left(\frac{1}{\sqrt{g}}\right)\sqrt{g}B^\theta\\
% 	&+ \frac{1}{\sqrt{g}}\sum_{k=0}^{L_{rad}}\sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}} -A_{l\phi kmn}T_{km}'(s)\cos(m\theta-nN_{fp}\phi)\label{eq. dbtds app}\\
% 	\frac{\partial B^\phi}{\partial s} &= \frac{\partial}{\partial s}\left(\frac{1}{\sqrt{g}}\right)\sqrt{g}B^\phi \\
% 	&+ \frac{1}{\sqrt{g}}\sum_{k=0}^{L_{rad}}\sum_{m=0}^{M_{pol}}\sum_{n=-N_{tor}}^{N_{tor}} A_{l\phi kmn}T_{km}'(s)\cos(m\theta-nN_{fp}\phi).\label{eq. dbzds app}
% \end{align}


